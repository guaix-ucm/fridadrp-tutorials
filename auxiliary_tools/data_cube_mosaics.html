

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generation of data cube mosaics &mdash; fridadrp-tutorials 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=42210275" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=3defd07e" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=d2c30f9d"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Auxiliary tools" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            fridadrp-tutorials
              <img src="../_static/logo_FRIDA.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/installation.html">Installing the development version</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifu_simulator/index.html">Running the IFU simulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example_recipes/test1.html">Running a simple test recipe</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Auxiliary tools</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Generation of data cube mosaics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#combination-of-2d-images">Combination of 2D images</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generation-of-individual-exposures">Generation of individual exposures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#combination-of-individual-exposures">Combination of individual exposures</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#combination-of-3d-data-cubes-example-1">Combination of 3D data cubes: example 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="#combination-of-3d-data-cubes-example-2">Combination of 3D data cubes: example 2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Generation of individual exposures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#examining-the-individual-data-cubes-before-combining-them">Examining the individual data cubes before combining them</a></li>
<li class="toctree-l4"><a class="reference internal" href="#combination-of-individual-data-cubes">Combination of individual data cubes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#differencial-atmospheric-refraction-correction">Differencial atmospheric refraction correction</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">fridadrp-tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Auxiliary tools</a></li>
      <li class="breadcrumb-item active">Generation of data cube mosaics</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/auxiliary_tools/data_cube_mosaics.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="generation-of-data-cube-mosaics">
<h1>Generation of data cube mosaics<a class="headerlink" href="#generation-of-data-cube-mosaics" title="Link to this heading"></a></h1>
<p>The code described below for mosaic generation relies on the use of the
<strong>reproject</strong> <a class="reference external" href="https://reproject.readthedocs.io/en/stable/" rel="noreferrer" target="_blank">package</a>, which
implements image reprojection methods for astronomical images.</p>
<p>The image combination assumes that the individual exposures to be combined are
provided in flux units (e.g., ADU/s or something proportional).</p>
<p>In this section, we’ll use auxiliary images that we’ll generate beforehand with
the help of <code class="docutils literal notranslate"><span class="pre">fridadrp-ifu_simulator</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Please note that the code shown below is under development and may undergo
modifications.</p>
</div>
<section id="combination-of-2d-images">
<h2>Combination of 2D images<a class="headerlink" href="#combination-of-2d-images" title="Link to this heading"></a></h2>
<p>Before tackling the combination of 3D data cubes, let’s see how the <strong>numina</strong>
package facilitates the combination of 2D FITS images.</p>
<section id="generation-of-individual-exposures">
<h3>Generation of individual exposures<a class="headerlink" href="#generation-of-individual-exposures" title="Link to this heading"></a></h3>
<p>For this example we are using the files <a class="reference download internal" download="" href="../_downloads/96bb14d814cc66efa584a8c42ceca92a/scene_m51_2d.yaml"><code class="xref download docutils literal notranslate"><span class="pre">scene_m51_2d.yaml</span></code></a> and <a class="reference download internal" download="" href="../_downloads/5758fa2f9c2a6b77d77ac2b8f18703c2/m51_dss1.fits"><code class="xref download docutils literal notranslate"><span class="pre">m51_dss1.fits</span></code></a>.</p>
<p>Execute <code class="docutils literal notranslate"><span class="pre">fridadrp-ifu_simulator</span></code> to generate the images to be combined:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_2d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>coarse<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_ra_teles_arcsec<span class="w"> </span><span class="m">0</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_dec_teles_arcsec<span class="w"> </span><span class="m">0</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">0</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--flatpix2pix<span class="w"> </span>none<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>test0a<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">1234</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_2d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>fine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_ra_teles_arcsec<span class="w"> </span>-0.1<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_dec_teles_arcsec<span class="w"> </span>-0.2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">40</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--flatpix2pix<span class="w"> </span>none<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>test0b<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">2345</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_2d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>fine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_ra_teles_arcsec<span class="w"> </span><span class="m">0</span>.2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_dec_teles_arcsec<span class="w"> </span><span class="m">0</span>.2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">20</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--flatpix2pix<span class="w"> </span>none<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>test0c<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">3456</span>
</pre></div>
</div>
<p>We have used the parameter <code class="docutils literal notranslate"><span class="pre">--stop_after_ifu_3D_method0</span></code> because we do not need
to execute all the steps of the simulator to generate the images we will need
in this case. Note that the first execution uses <code class="docutils literal notranslate"><span class="pre">--scale</span> <span class="pre">coarse</span></code>, while the
next two use <code class="docutils literal notranslate"><span class="pre">--scale</span> <span class="pre">fine</span></code>. Additionally, the values of
<code class="docutils literal notranslate"><span class="pre">--delta_ra_teles_arcsec</span></code>, <code class="docutils literal notranslate"><span class="pre">--delta_dec_teles_arcsec</span></code>, and
<code class="docutils literal notranslate"><span class="pre">--instrument_pa_deg</span></code> are different. However, since the airmass value is not
specified, it is assumed to be 1.0 in the three cases.</p>
<p>The files <code class="docutils literal notranslate"><span class="pre">test0?_ifu_white2D_method0_os1.fits</span></code> (with <code class="docutils literal notranslate"><span class="pre">?</span></code> equal to a, b or c)
can be examined with any visualization tool. The <strong>numina</strong> package provides
the auxiliary script <code class="docutils literal notranslate"><span class="pre">numina-ximshow</span></code> for this purpose</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-ximshow<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test0?_ifu_white2D_method0_os1.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cmap<span class="w"> </span>viridis<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cbar_orientation<span class="w"> </span>vertical<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--aspect<span class="w"> </span>equal<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--z1z2<span class="w"> </span>minmax
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/test0a_2d.png"><img alt="../_images/test0a_2d.png" src="../_images/test0a_2d.png" style="width: 32%;" />
</a>
<a class="reference internal image-reference" href="../_images/test0b_2d.png"><img alt="../_images/test0b_2d.png" src="../_images/test0b_2d.png" style="width: 32%;" />
</a>
<a class="reference internal image-reference" href="../_images/test0c_2d.png"><img alt="../_images/test0c_2d.png" src="../_images/test0c_2d.png" style="width: 32%;" />
</a>
<p>Note that it is also possible to visualize the collapsed view of the
corresponding 3D data cubes, using in this case the <strong>numina</strong> script
<code class="docutils literal notranslate"><span class="pre">numina-extract_2d_slice_from_3d_cube</span></code> (if no parameters are specified, it is
assumed that the collapse is performed along NAXIS3 and all pixels in that
direction are summed):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-extract_2d_slice_from_3d_cube<span class="w"> </span>test0a_ifu_3D_method0.fits
<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-extract_2d_slice_from_3d_cube<span class="w"> </span>test0b_ifu_3D_method0.fits
<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-extract_2d_slice_from_3d_cube<span class="w"> </span>test0c_ifu_3D_method0.fits
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/test0a_3d_collapsed.png"><img alt="../_images/test0a_3d_collapsed.png" src="../_images/test0a_3d_collapsed.png" style="width: 32%;" />
</a>
<a class="reference internal image-reference" href="../_images/test0b_3d_collapsed.png"><img alt="../_images/test0b_3d_collapsed.png" src="../_images/test0b_3d_collapsed.png" style="width: 32%;" />
</a>
<a class="reference internal image-reference" href="../_images/test0c_3d_collapsed.png"><img alt="../_images/test0c_3d_collapsed.png" src="../_images/test0c_3d_collapsed.png" style="width: 32%;" />
</a>
</section>
<section id="combination-of-individual-exposures">
<h3>Combination of individual exposures<a class="headerlink" href="#combination-of-individual-exposures" title="Link to this heading"></a></h3>
<p>The combination of the images is carried out using the <strong>numina</strong> script
<code class="docutils literal notranslate"><span class="pre">numina-generate_mosaic_of_2d_images</span></code>, which takes as input an ASCII file
containing the list of 2D FITS images to be combined, and the name of the
output file.</p>
<p>The first step is then to generate an auxiliary text file with the names of the
2D FITS images to be combined.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ls<span class="w"> </span>test0?_ifu_white2D_method0_os1.fits<span class="w"> </span>&gt;<span class="w"> </span>list0_2d_images.txt
<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>cat<span class="w"> </span>list0_2d_images.txt
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test0a_ifu_white2D_method0_os1</span><span class="o">.</span><span class="n">fits</span>
<span class="n">test0b_ifu_white2D_method0_os1</span><span class="o">.</span><span class="n">fits</span>
<span class="n">test0c_ifu_white2D_method0_os1</span><span class="o">.</span><span class="n">fits</span>
</pre></div>
</div>
<p>To combine the 3 selected images, we only need to execute the <strong>numina</strong>
script <code class="docutils literal notranslate"><span class="pre">numina-generate_mosaic_of_2d_images</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-generate_mosaic_of_2d_images<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>list0_2d_images.txt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>combination_test0_2d.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">input_list</span><span class="p">:</span> <span class="n">list0_2d_images</span><span class="o">.</span><span class="n">txt</span>
<span class="n">output_filename</span><span class="p">:</span> <span class="n">combination_test0_2d</span><span class="o">.</span><span class="n">fits</span>
<span class="n">reproject_method</span><span class="p">:</span> <span class="n">adaptive</span>
<span class="n">extname_image</span><span class="p">:</span> <span class="n">PRIMARY</span>
<span class="n">extname_mask</span><span class="p">:</span> <span class="kc">None</span>
<span class="n">combination_function</span><span class="p">:</span> <span class="n">mean</span>
<span class="n">output_3D_stack</span><span class="p">:</span> <span class="kc">None</span>
<span class="n">verbose</span><span class="p">:</span> <span class="kc">True</span>
<span class="n">echo</span><span class="p">:</span> <span class="kc">False</span>

<span class="o">*</span> <span class="n">Reading</span><span class="p">:</span> <span class="n">test0a_ifu_white2D_method0_os1</span><span class="o">.</span><span class="n">fits</span>
<span class="n">hdu2d_image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">64</span>
<span class="n">hdu2d_image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">60</span>
<span class="n">generating</span> <span class="n">mask</span> <span class="kn">from</span><span class="w"> </span><span class="nn">np.nan</span> <span class="n">values</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">masked</span> <span class="n">pixels</span> <span class="o">/</span> <span class="n">total</span><span class="p">:</span> <span class="mi">0</span> <span class="o">/</span> <span class="mi">3840</span>

<span class="o">*</span> <span class="n">Reading</span><span class="p">:</span> <span class="n">test0b_ifu_white2D_method0_os1</span><span class="o">.</span><span class="n">fits</span>
<span class="n">hdu2d_image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">64</span>
<span class="n">hdu2d_image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">60</span>
<span class="n">generating</span> <span class="n">mask</span> <span class="kn">from</span><span class="w"> </span><span class="nn">np.nan</span> <span class="n">values</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">masked</span> <span class="n">pixels</span> <span class="o">/</span> <span class="n">total</span><span class="p">:</span> <span class="mi">0</span> <span class="o">/</span> <span class="mi">3840</span>

<span class="o">*</span> <span class="n">Reading</span><span class="p">:</span> <span class="n">test0c_ifu_white2D_method0_os1</span><span class="o">.</span><span class="n">fits</span>
<span class="n">hdu2d_image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">64</span>
<span class="n">hdu2d_image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">60</span>
<span class="n">generating</span> <span class="n">mask</span> <span class="kn">from</span><span class="w"> </span><span class="nn">np.nan</span> <span class="n">values</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">masked</span> <span class="n">pixels</span> <span class="o">/</span> <span class="n">total</span><span class="p">:</span> <span class="mi">0</span> <span class="o">/</span> <span class="mi">3840</span>
<span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">images</span> <span class="n">to</span> <span class="n">be</span> <span class="n">combined</span><span class="p">:</span> <span class="mi">3</span>

<span class="n">wcs_mosaic2d</span><span class="o">=</span><span class="n">WCS</span> <span class="n">Keywords</span>

<span class="n">Number</span> <span class="n">of</span> <span class="n">WCS</span> <span class="n">axes</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">CTYPE</span> <span class="p">:</span> <span class="s1">&#39;RA---TAN&#39;</span> <span class="s1">&#39;DEC--TAN&#39;</span> 
<span class="n">CRVAL</span> <span class="p">:</span> <span class="mf">9.259258514947486e-06</span> <span class="mf">0.0</span> 
<span class="n">CRPIX</span> <span class="p">:</span> <span class="mf">125.16666693574936</span> <span class="mf">120.50000000417663</span> 
<span class="n">PC1_1</span> <span class="n">PC1_2</span>  <span class="p">:</span> <span class="mf">1.0</span> <span class="mf">0.0</span> 
<span class="n">PC2_1</span> <span class="n">PC2_2</span>  <span class="p">:</span> <span class="mf">0.0</span> <span class="mf">1.0</span> 
<span class="n">CDELT</span> <span class="p">:</span> <span class="o">-</span><span class="mf">2.7777777777777233e-06</span> <span class="mf">2.7777777777777233e-06</span> 
<span class="n">NAXIS</span> <span class="p">:</span> <span class="mi">0</span>  <span class="mi">0</span>
<span class="n">shape_mosaic2d</span><span class="o">=</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">Reprojection</span> <span class="n">method</span><span class="p">:</span> <span class="n">adaptive</span>
<span class="n">Combination</span> <span class="n">function</span><span class="p">:</span> <span class="n">mean</span>

<span class="n">Saving</span> <span class="n">combined</span> <span class="mi">2</span><span class="n">D</span> <span class="n">image</span><span class="p">:</span> <span class="n">combination_test0_2d</span><span class="o">.</span><span class="n">fits</span>
</pre></div>
</div>
<p>Next, we compare the result of the combination of the 3 simulated exposures
with the first exposure alone: both cover the field of the <em>coarse</em> camera. The
improvement in spatial resolution in the combined image is noticeable after
including the two pointings made with the <em>fine</em> camera.  Note that the
combined image has the sampling corresponding to the <em>fine</em> camera. Hence, the
number of counts shows such a different value in both images.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-ximshow<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>combination_test0_2d.fits<span class="w"> </span>test0a_ifu_white2D_method0_os1.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cmap<span class="w"> </span>viridis<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--cbar_orientation<span class="w"> </span>vertical<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--aspect<span class="w"> </span>equal<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--z1z2<span class="w"> </span>minmax
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/combined_test0_2d.png"><img alt="../_images/combined_test0_2d.png" src="../_images/combined_test0_2d.png" style="width: 49%;" />
</a>
<a class="reference internal image-reference" href="../_images/single_test0a_2d.png"><img alt="../_images/single_test0a_2d.png" src="../_images/single_test0a_2d.png" style="width: 49%;" />
</a>
<p>The following figure shows the result of combining the two exposures obtained
with the ‘fine’ camera, represented on top of the first exposure calculated
with an oversampling of 10 (file <code class="docutils literal notranslate"><span class="pre">testa_ifu_white2D_method0_os10.fits</span></code>).</p>
<a class="reference internal image-reference" href="../_images/combined_with_bw_background.png"><img alt="../_images/combined_with_bw_background.png" class="align-center" src="../_images/combined_with_bw_background.png" style="width: 70%;" />
</a>
</section>
</section>
<section id="combination-of-3d-data-cubes-example-1">
<h2>Combination of 3D data cubes: example 1<a class="headerlink" href="#combination-of-3d-data-cubes-example-1" title="Link to this heading"></a></h2>
<p>We can start by combining the three 3D cubes generated in the previous section.
Let us recall that in this case, the three cubes cover different solid angles
on the celestial sphere but span the same wavelength range. Likewise, we do not
have issues with differential atmospheric refraction within each data cube
because we have assumed an airmass of 1.0.</p>
<p>The combination of the images is carried out using the <strong>numina</strong> script
<code class="docutils literal notranslate"><span class="pre">numina-generate_mosaic_of_3d_cubes</span></code>, which takes as input an ASCII file
containing the list of 3D FITS images to be combined, and the name of the
output file.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ls<span class="w"> </span>test0?_ifu_3D_method0.fits<span class="w"> </span>&gt;<span class="w"> </span>list0_3d_cubes.txt
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>cat<span class="w"> </span>list0_3d_cubes.txt<span class="w"> </span>
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test0a_ifu_3D_method0</span><span class="o">.</span><span class="n">fits</span>
<span class="n">test0b_ifu_3D_method0</span><span class="o">.</span><span class="n">fits</span>
<span class="n">test0c_ifu_3D_method0</span><span class="o">.</span><span class="n">fits</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-generate_mosaic_of_3d_cubes<span class="w"> </span><span class="se">\ </span>
<span class="go">  list0_3d_cubes.txt \</span>
<span class="go">  all0_3d.fits \</span>
<span class="go">  --reproject_method adaptive \</span>
<span class="go">  --footprint \</span>
<span class="go">  --verbose</span>
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span>input_list: list0_3d_cubes.txt
output_filename: all0_3d.fits
crval3out: None
cdelt3out: None
naxis3out: None
desired_celestial_2d_wcs: None
reproject_method: adaptive
parallel: False
extname_image: PRIMARY
output_celestial_2d_wcs: None
footprint: True
verbose: True
echo: False
Total number of images to be combined: 3
hdu.header[&quot;NAXIS1&quot;]=64, hdu.header[&quot;NAXIS2&quot;]=60, hdu.header[&quot;NAXIS3&quot;]=2048
hdu.header[&quot;NAXIS1&quot;]=64, hdu.header[&quot;NAXIS2&quot;]=60, hdu.header[&quot;NAXIS3&quot;]=2048
hdu.header[&quot;NAXIS1&quot;]=64, hdu.header[&quot;NAXIS2&quot;]=60, hdu.header[&quot;NAXIS3&quot;]=2048

crval3out=&lt;SpectralCoord 1.9344e-06 m&gt;
cdelt3out=&lt;Quantity 2.85e-10 m / pix&gt;
naxis3out=2048
wavemax  =&lt;Quantity 2.517795e-06 m&gt;

wcs1d_spectral_mosaic=WCS Keywords

Number of WCS axes: 1
CTYPE : &#39;WAVE&#39; 
CRVAL : 1.9344e-06 
CRPIX : 1.0 
PC1_1  : 1.0 
CDELT : 2.84999999999608e-10 
NAXIS : 2048  0

Celestial scales:
Image 1: 0.040 arcsec, 0.040 arcsec
Image 2: 0.010 arcsec, 0.010 arcsec
Image 3: 0.010 arcsec, 0.010 arcsec
Mosaic : 0.010 arcsec, 0.010 arcsec

wcs_mosaic2d=WCS Keywords

Number of WCS axes: 2
CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39; 
CRVAL : 9.259258514947486e-06 0.0 
CRPIX : 125.16666693574936 120.50000000417663 
PC1_1 PC1_2  : 1.0 0.0 
PC2_1 PC2_2  : 0.0 1.0 
CDELT : -2.7777777777777233e-06 2.7777777777777233e-06 
NAXIS : 0  0

shape_mosaic2d=(240, 256)

NAXIS1, NAXIS2, NAXIS3 of 3D mosaic: 256, 240, 2048
Combined image will require 600.00 Mbyte

* Working with: test0a_ifu_3D_method0.fits
Old and new wavelength borders are the same.
-&gt; Copying original data without spectral resampling.
Celestial WCS reprojection method: adaptive
Processing time for test0a_ifu_3D_method0.fits: 0:00:19.641678

* Working with: test0b_ifu_3D_method0.fits
Old and new wavelength borders are the same.
-&gt; Copying original data without spectral resampling.
Celestial WCS reprojection method: adaptive
Processing time for test0b_ifu_3D_method0.fits: 0:00:02.132979

* Working with: test0c_ifu_3D_method0.fits
Old and new wavelength borders are the same.
-&gt; Copying original data without spectral resampling.
Celestial WCS reprojection method: adaptive
Processing time for test0c_ifu_3D_method0.fits: 0:00:02.113682
Saving: all0_3d.fits

Total time: 0:00:24.587678
Done!
</pre></div>
</div>
<p>We can visualize the result using <code class="docutils literal notranslate"><span class="pre">ds9</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ds9<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-scale<span class="w"> </span>mode<span class="w"> </span>minmax<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-geometry<span class="w"> </span>1000x1000<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-wcs<span class="w"> </span>degrees<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-multiframe<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test0a_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test0b_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test0c_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>all0_3d.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-lock<span class="w"> </span>slice<span class="w"> </span>image<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-lock<span class="w"> </span>frame<span class="w"> </span>image<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-zoom<span class="w"> </span>to<span class="w"> </span>fit<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-cmap<span class="w"> </span>viridis<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-match<span class="w"> </span>frame<span class="w"> </span>colorbar<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-match<span class="w"> </span>frame<span class="w"> </span>wcs<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-colorbar<span class="w"> </span>lock<span class="w"> </span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-view<span class="w"> </span>multi<span class="w"> </span>yes
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/result_example1_with_ds9.png"><img alt="../_images/result_example1_with_ds9.png" class="align-center" src="../_images/result_example1_with_ds9.png" style="width: 70%;" />
</a>
<p>In the first row, the three individual exposures are shown. In the bottom row,
the image on the left corresponds to the combination of the three individual
exposures, while the image in the center is the footprint of that combination.</p>
</section>
<section id="combination-of-3d-data-cubes-example-2">
<h2>Combination of 3D data cubes: example 2<a class="headerlink" href="#combination-of-3d-data-cubes-example-2" title="Link to this heading"></a></h2>
<p>In this case, we will introduce the effect of differential atmospheric
refraction, using exposures of the same region of the sky but with different
airmasses and position angles.</p>
<section id="id1">
<h3>Generation of individual exposures<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>For this example we are using the file <a class="reference download internal" download="" href="../_downloads/cf5503c41b9ea822a124f47a72e04399/scene_m51_3d.yaml"><code class="xref download docutils literal notranslate"><span class="pre">scene_m51_3d.yaml</span></code></a>.</p>
<p>Execute <code class="docutils literal notranslate"><span class="pre">fridadrp-ifu_simulator</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_3d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>fine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--airmass<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--parallactic_angle_deg<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>test1a<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">1234</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_3d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>fine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--airmass<span class="w"> </span><span class="m">3</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--parallactic_angle_deg<span class="w"> </span><span class="m">45</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>test1b<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">2345</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_3d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>fine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--airmass<span class="w"> </span><span class="m">3</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--parallactic_angle_deg<span class="w"> </span>-45<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">340</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>test1c<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">3456</span>
</pre></div>
</div>
<p>We have used again the parameter <code class="docutils literal notranslate"><span class="pre">--stop_after_ifu_3D_method0</span></code> because we do
not need to execute all the steps of the simulator to generate the images we
will need in this example. In all cases, we are using the <em>fine</em> camera.  In
the first exposure, the airmass is 1.0. In the next two exposures we have
chosen a high airmass to exaggerate the effect of atmospheric refraction,
modifying both the value of the parallactic angle and the instrument.</p>
</section>
<section id="examining-the-individual-data-cubes-before-combining-them">
<h3>Examining the individual data cubes before combining them<a class="headerlink" href="#examining-the-individual-data-cubes-before-combining-them" title="Link to this heading"></a></h3>
<p>We can quickly visualize the result with the help of the <code class="docutils literal notranslate"><span class="pre">ds9</span></code> program.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ds9<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-scale<span class="w"> </span>mode<span class="w"> </span>minmax<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-geometry<span class="w"> </span>1000x1000<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-wcs<span class="w"> </span>degrees<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-multiframe<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1a_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1b_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1c_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-lock<span class="w"> </span>slice<span class="w"> </span>image<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-lock<span class="w"> </span>frame<span class="w"> </span>image<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-zoom<span class="w"> </span>to<span class="w"> </span>fit<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-cmap<span class="w"> </span>viridis<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-match<span class="w"> </span>frame<span class="w"> </span>colorbar<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-colorbar<span class="w"> </span>lock<span class="w"> </span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-view<span class="w"> </span>multi<span class="w"> </span>yes
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/individual_3d_m51_exposures_with_ds9.png"><img alt="../_images/individual_3d_m51_exposures_with_ds9.png" src="../_images/individual_3d_m51_exposures_with_ds9.png" style="width: 100%;" />
</a>
<p>It is also possible to use <code class="docutils literal notranslate"><span class="pre">qfitsview</span></code> to visualize simultaneously the
individual exposures. In this case, with the idea of being able to change the
slice in the spectral direction simultaneously in the three exposures, we will
first generate an auxiliary image that performs a stack of the HDUs (header and
data units) from different FITS files into a single FITS file. For that
purpose, we can employ the <strong>numina</strong> script <code class="docutils literal notranslate"><span class="pre">numina-stack_hdus</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fitsinfo<span class="w"> </span>test1*3D*.fits
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Filename</span><span class="p">:</span> <span class="n">test1a_ifu_3D_method0</span><span class="o">.</span><span class="n">fits</span>
<span class="n">No</span><span class="o">.</span>    <span class="n">Name</span>      <span class="n">Ver</span>    <span class="n">Type</span>      <span class="n">Cards</span>   <span class="n">Dimensions</span>   <span class="n">Format</span>
  <span class="mi">0</span>  <span class="n">PRIMARY</span>       <span class="mi">1</span> <span class="n">PrimaryHDU</span>      <span class="mi">82</span>   <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>   <span class="n">int16</span> <span class="p">(</span><span class="n">rescales</span> <span class="n">to</span> <span class="n">uint16</span><span class="p">)</span>   
   
<span class="n">Filename</span><span class="p">:</span> <span class="n">test1b_ifu_3D_method0</span><span class="o">.</span><span class="n">fits</span>
<span class="n">No</span><span class="o">.</span>    <span class="n">Name</span>      <span class="n">Ver</span>    <span class="n">Type</span>      <span class="n">Cards</span>   <span class="n">Dimensions</span>   <span class="n">Format</span>
  <span class="mi">0</span>  <span class="n">PRIMARY</span>       <span class="mi">1</span> <span class="n">PrimaryHDU</span>      <span class="mi">84</span>   <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>   <span class="n">int16</span> <span class="p">(</span><span class="n">rescales</span> <span class="n">to</span> <span class="n">uint16</span><span class="p">)</span>   
   
<span class="n">Filename</span><span class="p">:</span> <span class="n">test1c_ifu_3D_method0</span><span class="o">.</span><span class="n">fits</span>
<span class="n">No</span><span class="o">.</span>    <span class="n">Name</span>      <span class="n">Ver</span>    <span class="n">Type</span>      <span class="n">Cards</span>   <span class="n">Dimensions</span>   <span class="n">Format</span>
  <span class="mi">0</span>  <span class="n">PRIMARY</span>       <span class="mi">1</span> <span class="n">PrimaryHDU</span>      <span class="mi">84</span>   <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>   <span class="n">int16</span> <span class="p">(</span><span class="n">rescales</span> <span class="n">to</span> <span class="n">uint16</span><span class="p">)</span>   
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ls<span class="w"> </span>test1*3D*.fits<span class="w"> </span>&gt;<span class="w"> </span>list1_3d_cubes.txt
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>cat<span class="w"> </span>list1_3d_cubes.txt
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test1a_ifu_3D_method0</span><span class="o">.</span><span class="n">fits</span>
<span class="n">test1b_ifu_3D_method0</span><span class="o">.</span><span class="n">fits</span>
<span class="n">test1c_ifu_3D_method0</span><span class="o">.</span><span class="n">fits</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-stack_hdus<span class="w"> </span>list1_3d_cubes.txt<span class="w"> </span>stack1_3d.fits
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>qfitsview<span class="w"> </span>stack1_3d.fits
</pre></div>
</div>
<p>After executing the last command, select ‘Read All’ when <code class="docutils literal notranslate"><span class="pre">qfitsview</span></code> asks for
the extension to read.</p>
<a class="reference internal image-reference" href="../_images/individual_3d_m51_exposures_with_qfitsview.png"><img alt="../_images/individual_3d_m51_exposures_with_qfitsview.png" src="../_images/individual_3d_m51_exposures_with_qfitsview.png" style="width: 100%;" />
</a>
<p>If we collapse the data cubes along the spectral direction (NAXIS3), the effect
of atmospheric refraction is clearly noticeable.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-extract_2d_slice_from_3d_cube<span class="w"> </span>test1a_ifu_3D_method0.fits
<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-extract_2d_slice_from_3d_cube<span class="w"> </span>test1b_ifu_3D_method0.fits
<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-extract_2d_slice_from_3d_cube<span class="w"> </span>test1c_ifu_3D_method0.fits
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/test1a_3d_collapsed.png"><img alt="../_images/test1a_3d_collapsed.png" src="../_images/test1a_3d_collapsed.png" style="width: 32%;" />
</a>
<a class="reference internal image-reference" href="../_images/test1b_3d_collapsed.png"><img alt="../_images/test1b_3d_collapsed.png" src="../_images/test1b_3d_collapsed.png" style="width: 32%;" />
</a>
<a class="reference internal image-reference" href="../_images/test1c_3d_collapsed.png"><img alt="../_images/test1c_3d_collapsed.png" src="../_images/test1c_3d_collapsed.png" style="width: 32%;" />
</a>
</section>
<section id="combination-of-individual-data-cubes">
<h3>Combination of individual data cubes<a class="headerlink" href="#combination-of-individual-data-cubes" title="Link to this heading"></a></h3>
<p>If we combine the previous 3 data cubes ignoring the problem of atmospheric
refraction, the result is not satisfactory.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-generate_mosaic_of_3d_cubes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>list1_3d_cubes.txt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>combination_test1_3d.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--footprint<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span>input_list: list1_3d_cubes.txt
output_filename: combination_test1_3d.fits
crval3out: None
cdelt3out: None
naxis3out: None
desired_celestial_2d_wcs: None
reproject_method: adaptive
parallel: False
extname_image: PRIMARY
output_celestial_2d_wcs: None
footprint: True
verbose: True
echo: False
Total number of images to be combined: 3
hdu.header[&quot;NAXIS1&quot;]=64, hdu.header[&quot;NAXIS2&quot;]=60, hdu.header[&quot;NAXIS3&quot;]=2048
hdu.header[&quot;NAXIS1&quot;]=64, hdu.header[&quot;NAXIS2&quot;]=60, hdu.header[&quot;NAXIS3&quot;]=2048
hdu.header[&quot;NAXIS1&quot;]=64, hdu.header[&quot;NAXIS2&quot;]=60, hdu.header[&quot;NAXIS3&quot;]=2048

crval3out=&lt;SpectralCoord 1.9344e-06 m&gt;
cdelt3out=&lt;Quantity 2.85e-10 m / pix&gt;
naxis3out=2048
wavemax  =&lt;Quantity 2.517795e-06 m&gt;

wcs1d_spectral_mosaic=WCS Keywords

Number of WCS axes: 1
CTYPE : &#39;WAVE&#39; 
CRVAL : 1.9344e-06 
CRPIX : 1.0 
PC1_1  : 1.0 
CDELT : 2.84999999999608e-10 
NAXIS : 2048  0

Celestial scales:
Image 1: 0.010 arcsec, 0.010 arcsec
Image 2: 0.010 arcsec, 0.010 arcsec
Image 3: 0.010 arcsec, 0.010 arcsec
Mosaic : 0.010 arcsec, 0.010 arcsec

wcs_mosaic2d=WCS Keywords

Number of WCS axes: 2
CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39; 
CRVAL : 4.296495291499103e-31 0.0 
CRPIX : 40.83076816991048 39.63542321434076 
PC1_1 PC1_2  : 1.0 0.0 
PC2_1 PC2_2  : 0.0 1.0 
CDELT : -2.7777777777777e-06 2.7777777777777e-06 
NAXIS : 0  0

shape_mosaic2d=(78, 81)

NAXIS1, NAXIS2, NAXIS3 of 3D mosaic: 81, 78, 2048
Combined image will require 61.70 Mbyte

* Working with: test1a_ifu_3D_method0.fits
Old and new wavelength borders are the same.
-&gt; Copying original data without spectral resampling.
Celestial WCS reprojection method: adaptive
Processing time for test1a_ifu_3D_method0.fits: 0:00:00.577247

* Working with: test1b_ifu_3D_method0.fits
Old and new wavelength borders are the same.
-&gt; Copying original data without spectral resampling.
Celestial WCS reprojection method: adaptive
Processing time for test1b_ifu_3D_method0.fits: 0:00:00.564567

* Working with: test1c_ifu_3D_method0.fits
Old and new wavelength borders are the same.
-&gt; Copying original data without spectral resampling.
Celestial WCS reprojection method: adaptive
Processing time for test1c_ifu_3D_method0.fits: 0:00:00.568156
Saving: combination_test1_3d.fits

Total time: 0:00:01.816519
Done!
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fitsinfo<span class="w"> </span>combination_test1_3d.fits
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Filename: combination_test1_3d.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      50   (81, 78, 2048)   float32   </span>
<span class="go">  1  FOOTPRINT     1 ImageHDU        29   (81, 78, 2048)   uint8 </span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>qfitsview<span class="w"> </span>combination_test1_3d.fits
</pre></div>
</div>
<p>The initial spatial cut shown by qfitsview corresponds to pixel 1024 along
NAXIS3. The corresponding image looks apparently normal.</p>
<a class="reference internal image-reference" href="../_images/combined_test1_3d_1024.png"><img alt="../_images/combined_test1_3d_1024.png" class="align-center" src="../_images/combined_test1_3d_1024.png" style="width: 70%;" />
</a>
<p>However, when we display the cut corresponding to pixel 1 or pixel 2048, the
result is clearly not satisfactory.</p>
<a class="reference internal image-reference" href="../_images/combined_test1_3d_0001.png"><img alt="../_images/combined_test1_3d_0001.png" src="../_images/combined_test1_3d_0001.png" style="width: 49%;" />
</a>
<a class="reference internal image-reference" href="../_images/combined_test1_3d_2048.png"><img alt="../_images/combined_test1_3d_2048.png" src="../_images/combined_test1_3d_2048.png" style="width: 49%;" />
</a>
</section>
<section id="differencial-atmospheric-refraction-correction">
<h3>Differencial atmospheric refraction correction<a class="headerlink" href="#differencial-atmospheric-refraction-correction" title="Link to this heading"></a></h3>
<p>It is advisable to correct the individual exposures for differential
atmospheric refraction (taking as reference the position of the image at the
central wavelength along NAXIS3). To do this, we will start by using an
auxiliary script that helps us visualize how significant the effect is in the
images we are working with.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-compute_adr_wavelength<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--airmass<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--reference_wave_vacuum<span class="w"> </span><span class="m">1</span>.7<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--wave_ini<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--wave_end<span class="w"> </span><span class="m">2</span>.5<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--wave_step<span class="w"> </span><span class="m">0</span>.1<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--wave_unit<span class="w"> </span>micron<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--plots
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Wavelength</span>  <span class="n">ADR</span>  
  <span class="n">micron</span>   <span class="n">arcsec</span>
<span class="o">----------</span> <span class="o">------</span>
     <span class="mf">1.000</span>  <span class="mf">0.483</span>
     <span class="mf">1.100</span>  <span class="mf">0.355</span>
     <span class="mf">1.200</span>  <span class="mf">0.257</span>
     <span class="mf">1.300</span>  <span class="mf">0.181</span>
     <span class="mf">1.400</span>  <span class="mf">0.121</span>
     <span class="mf">1.500</span>  <span class="mf">0.072</span>
     <span class="mf">1.600</span>  <span class="mf">0.033</span>
     <span class="mf">1.700</span>  <span class="mf">0.000</span>
     <span class="mf">1.800</span> <span class="o">-</span><span class="mf">0.027</span>
     <span class="mf">1.900</span> <span class="o">-</span><span class="mf">0.051</span>
     <span class="mf">2.000</span> <span class="o">-</span><span class="mf">0.071</span>
     <span class="mf">2.100</span> <span class="o">-</span><span class="mf">0.088</span>
     <span class="mf">2.200</span> <span class="o">-</span><span class="mf">0.102</span>
     <span class="mf">2.300</span> <span class="o">-</span><span class="mf">0.115</span>
     <span class="mf">2.400</span> <span class="o">-</span><span class="mf">0.127</span>
     <span class="mf">2.500</span> <span class="o">-</span><span class="mf">0.137</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/adr_prediction.png"><img alt="../_images/adr_prediction.png" class="align-center" src="../_images/adr_prediction.png" style="width: 60%;" />
</a>
<p>When correcting each individual exposure, we will first insert an extension
with a binary table that stores the effect of atmospheric refraction into each
FITS file.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fitsheader<span class="w"> </span>-k<span class="w"> </span>airmass<span class="w"> </span>test1?_ifu_3D_method0.fits<span class="w"> </span>-f
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">         filename          AIRMASS</span>
<span class="go">-------------------------- -------</span>
<span class="go">test1a_ifu_3D_method0.fits     1.0</span>
<span class="go">test1b_ifu_3D_method0.fits     3.0</span>
<span class="go">test1c_ifu_3D_method0.fits     3.0</span>
</pre></div>
</div>
<p>Only the second and third images need to be corrected. The first one was
obtained with an airmass of 1.0.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-include_adrtheor_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1b_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose<span class="w"> </span>--plots
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/adr_test1b.png"><img alt="../_images/adr_test1b.png" class="align-center" src="../_images/adr_test1b.png" style="width: 100%;" />
</a>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-include_adrtheor_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1c_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose<span class="w"> </span>--plots
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/adr_test1c.png"><img alt="../_images/adr_test1c.png" class="align-center" src="../_images/adr_test1c.png" style="width: 100%;" />
</a>
<p><strong>Important</strong>: the previous step stores the correction to be applied but does
not apply it to the data. To perform this process, we need to use an additional
script.</p>
<p>We see that a new extension <code class="docutils literal notranslate"><span class="pre">ADRTHEOR</span></code> has appeared in each data cube.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fitsinfo<span class="w"> </span>test1*3D*.fits
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Filename: test1a_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      82   (64, 60, 2048)   int16 (rescales to uint16)   </span>
<span class="go">   </span>
<span class="go">Filename: test1b_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      84   (64, 60, 2048)   int16 (rescales to uint16)   </span>
<span class="go">  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]   </span>
<span class="go">   </span>
<span class="go">Filename: test1c_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      84   (64, 60, 2048)   int16 (rescales to uint16)   </span>
<span class="go">  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]   </span>
</pre></div>
</div>
<p>We can also empirically measure atmospheric refraction in each data cube using
cross-correlation.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-measure_slice_xy_offsets_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1b_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--iterate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname<span class="w"> </span>adrcross<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose<span class="w"> </span>--iterate<span class="w"> </span>--plots
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-measure_slice_xy_offsets_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1c_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--iterate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname<span class="w"> </span>adrcross<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose<span class="w"> </span>--iterate<span class="w"> </span>--plots
</pre></div>
</div>
<p>The previous procedure has added a new extension <code class="docutils literal notranslate"><span class="pre">ADRCROSS</span></code> to each of the
corrected images.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fitsinfo<span class="w"> </span>test1*3D*.fits
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Filename: test1a_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      82   (64, 60, 2048)   int16 (rescales to uint16)   </span>
<span class="go">   </span>
<span class="go">Filename: test1b_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      84   (64, 60, 2048)   int16 (rescales to uint16)   </span>
<span class="go">  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]   </span>
<span class="go">  2  ADRCROSS      1 BinTableHDU     24   2048R x 2C   [D, D]   </span>
<span class="go">   </span>
<span class="go">Filename: test1c_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      84   (64, 60, 2048)   int16 (rescales to uint16)   </span>
<span class="go">  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]   </span>
<span class="go">  2  ADRCROSS      1 BinTableHDU     24   2048R x 2C   [D, D] </span>
</pre></div>
</div>
<p>We can easily compare the expected atmospheric refraction with that calculated
using the cross-correlation technique.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-compare_adr_extensions_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1b_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>adrcross<span class="w"> </span>adrtheor
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/adrcross_adrtheor.png"><img alt="../_images/adrcross_adrtheor.png" class="align-center" src="../_images/adrcross_adrtheor.png" style="width: 100%;" />
</a>
<p>At this point, we can correct the exposures for atmospheric refraction using
the preferred extension (in this case, <code class="docutils literal notranslate"><span class="pre">ADRCROSS</span></code> or <code class="docutils literal notranslate"><span class="pre">ADRTHEOR</span></code>).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-adr_correction_from_extension_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1b_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname_adr<span class="w"> </span>adrtheor<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname_mask<span class="w"> </span>None<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>test1b_ifu_3D_method0_corrected_ADRTHEOR.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span>inputfile: test1b_ifu_3D_method0.fits
extname_adr: adrtheor
extname_mask: None
final_celestial_wcs: None
output: test1b_ifu_3D_method0_corrected_ADRTHEOR.fits
reproject_method: adaptive
verbose: True
echo: False
Filename: test1b_ifu_3D_method0.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU      84   (64, 60, 2048)   int16 (rescales to uint16)   
  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]   
  2  ADRCROSS      1 BinTableHDU     24   2048R x 2C   [D, D]   
None
Reading ADR correction from ADRTHEOR extension
Generating mask from np.nan in PRIMARY HDU
Number of masked pixels in the input 3D array: 0
Center IFU coord: &lt;SkyCoord (ICRS): (ra, dec) in deg
    (4.29649529e-31, 0.)&gt;

wcs2d_blue:
WCS Keywords

Number of WCS axes: 2
CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39; 
CRVAL : 0.0 0.0 
CRPIX : 30.47089355891503 34.85143279557968 
CD1_1 CD1_2  : -2.6102572799608e-06 9.5005595368241e-07 
CD2_1 CD2_2  : 9.5005595368241e-07 2.6102572799608e-06 
NAXIS : 64  60

wcs2d_red:
WCS Keywords

Number of WCS axes: 2
CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39; 
CRVAL : 0.0 0.0 
CRPIX : 33.86438885042125 27.574058674345103 
CD1_1 CD1_2  : -2.6102572799608e-06 9.5005595368241e-07 
CD2_1 CD2_2  : 9.5005595368241e-07 2.6102572799608e-06 
NAXIS : 64  60

wcs_mosaic2d:
WCS Keywords

Number of WCS axes: 2
CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39; 
CRVAL : 4.296495291499103e-31 0.0 
CRPIX : 43.11360516821077 43.03043722644195 
PC1_1 PC1_2  : 1.0 0.0 
PC2_1 PC2_2  : 0.0 1.0 
CDELT : -2.7777777777777233e-06 2.7777777777777233e-06 
NAXIS : 0  0
shape_mosaic2d: (84, 86)
NAXIS1, NAXIS2, NAXIS3 of corrected 3D cube: 86, 84, 2048
Reprojection method: adaptive (please wait...)
Reprojection finished! (elapsed time: 13.683667 seconds)

Flux check:
- total counts in original  3D cube: 84579025
- total counts in corrected 3D cube: 84272326.60160962
- ratio original/corrected.........: 1.003639372623949

Footprint coverage (fraction): 0.4813108729365656

header3d_corrected:
WCSAXES =                    3 / Number of coordinate axes                      
CRPIX1  =      43.113605168211 / Pixel coordinate of reference point            
CRPIX2  =      43.030437226442 / Pixel coordinate of reference point            
CRPIX3  =                  1.0 / Pixel coordinate of reference point            
CDELT1  = -2.7777777777777E-06 / [deg] Coordinate increment at reference point  
CDELT2  =  2.7777777777777E-06 / [deg] Coordinate increment at reference point  
CDELT3  = 2.85000000000032E-10 / [m] Coordinate increment at reference point    
CUNIT1  = &#39;deg&#39;                / Units of coordinate increment and value        
CUNIT2  = &#39;deg&#39;                / Units of coordinate increment and value        
CUNIT3  = &#39;m       &#39;           / Units of coordinate increment and value        
CTYPE1  = &#39;RA---TAN&#39;           / Right ascension, gnomonic projection           
CTYPE2  = &#39;DEC--TAN&#39;           / Declination, gnomonic projection               
CTYPE3  = &#39;WAVE    &#39;           / Vacuum wavelength (linear)                     
CRVAL1  =  4.2964952914991E-31 / [deg] Coordinate value at reference point      
CRVAL2  =                  0.0 / [deg] Coordinate value at reference point      
CRVAL3  =           1.9344E-06 / [m] Coordinate value at reference point        
LONPOLE =                180.0 / [deg] Native longitude of celestial pole       
LATPOLE =                  0.0 / [deg] Native latitude of celestial pole        
MJDREF  =                  0.0 / [d] MJD of fiducial time                       
RADESYS = &#39;ICRS&#39;               / Equatorial coordinate system                   

Saving file: test1b_ifu_3D_method0_corrected_ADRTHEOR.fits
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-adr_correction_from_extension_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1c_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname_adr<span class="w"> </span>adrtheor<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname_mask<span class="w"> </span>None<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>test1c_ifu_3D_method0_corrected_ADRTHEOR.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span>inputfile: test1c_ifu_3D_method0.fits
extname_adr: adrtheor
extname_mask: None
final_celestial_wcs: None
output: test1c_ifu_3D_method0_corrected_ADRTHEOR.fits
reproject_method: adaptive
verbose: True
echo: False
Filename: test1c_ifu_3D_method0.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU      84   (64, 60, 2048)   int16 (rescales to uint16)   
  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]   
  2  ADRCROSS      1 BinTableHDU     24   2048R x 2C   [D, D]   
None
Reading ADR correction from ADRTHEOR extension
Generating mask from np.nan in PRIMARY HDU
Number of masked pixels in the input 3D array: 0
Center IFU coord: &lt;SkyCoord (ICRS): (ra, dec) in deg
    (4.29649529e-31, 0.)&gt;

wcs2d_blue:
WCS Keywords

Number of WCS axes: 2
CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39; 
CRVAL : 0.0 0.0 
CRPIX : 34.52910644625764 34.8514327982211 
CD1_1 CD1_2  : -2.6102572799608e-06 -9.5005595368241e-07 
CD2_1 CD2_2  : -9.5005595368241e-07 2.6102572799608e-06 
NAXIS : 64  60

wcs2d_red:
WCS Keywords

Number of WCS axes: 2
CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39; 
CRVAL : 0.0 0.0 
CRPIX : 31.135611152816494 27.574058672835317 
CD1_1 CD1_2  : -2.6102572799608e-06 -9.5005595368241e-07 
CD2_1 CD2_2  : -9.5005595368241e-07 2.6102572799608e-06 
NAXIS : 64  60

wcs_mosaic2d:
WCS Keywords

Number of WCS axes: 2
CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39; 
CRVAL : 4.296495291499103e-31 0.0 
CRPIX : 44.22578218603953 43.03043723461774 
PC1_1 PC1_2  : 1.0 0.0 
PC2_1 PC2_2  : 0.0 1.0 
CDELT : -2.7777777777777233e-06 2.7777777777777233e-06 
NAXIS : 0  0
shape_mosaic2d: (84, 86)
NAXIS1, NAXIS2, NAXIS3 of corrected 3D cube: 86, 84, 2048
Reprojection method: adaptive (please wait...)
Reprojection finished! (elapsed time: 13.578309 seconds)

Flux check:
- total counts in original  3D cube: 84480108
- total counts in corrected 3D cube: 84274917.53627832
- ratio original/corrected.........: 1.0024347750163427

Footprint coverage (fraction): 0.4813119544011282

header3d_corrected:
WCSAXES =                    3 / Number of coordinate axes                      
CRPIX1  =       44.22578218604 / Pixel coordinate of reference point            
CRPIX2  =      43.030437234618 / Pixel coordinate of reference point            
CRPIX3  =                  1.0 / Pixel coordinate of reference point            
CDELT1  = -2.7777777777777E-06 / [deg] Coordinate increment at reference point  
CDELT2  =  2.7777777777777E-06 / [deg] Coordinate increment at reference point  
CDELT3  = 2.85000000000032E-10 / [m] Coordinate increment at reference point    
CUNIT1  = &#39;deg&#39;                / Units of coordinate increment and value        
CUNIT2  = &#39;deg&#39;                / Units of coordinate increment and value        
CUNIT3  = &#39;m       &#39;           / Units of coordinate increment and value        
CTYPE1  = &#39;RA---TAN&#39;           / Right ascension, gnomonic projection           
CTYPE2  = &#39;DEC--TAN&#39;           / Declination, gnomonic projection               
CTYPE3  = &#39;WAVE    &#39;           / Vacuum wavelength (linear)                     
CRVAL1  =  4.2964952914991E-31 / [deg] Coordinate value at reference point      
CRVAL2  =                  0.0 / [deg] Coordinate value at reference point      
CRVAL3  =           1.9344E-06 / [m] Coordinate value at reference point        
LONPOLE =                180.0 / [deg] Native longitude of celestial pole       
LATPOLE =                  0.0 / [deg] Native latitude of celestial pole        
MJDREF  =                  0.0 / [d] MJD of fiducial time                       
RADESYS = &#39;ICRS&#39;               / Equatorial coordinate system                   

Saving file: test1c_ifu_3D_method0_corrected_ADRTHEOR.fits
</pre></div>
</div>
<p>Next, we add the 3 cubes (the first one uncorrected and the second and third
cubes corrected).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ls<span class="w"> </span>test1a_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1*_ADRTHEOR.fits<span class="w"> </span>&gt;<span class="w"> </span>list1_3d_images_ADRTHEOR.txt
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>cat<span class="w"> </span>list1_3d_images_ADRTHEOR.txt
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">test1a_ifu_3D_method0.fits</span>
<span class="go">test1b_ifu_3D_method0_corrected_ADRTHEOR.fits</span>
<span class="go">test1c_ifu_3D_method0_corrected_ADRTHEOR.fits</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-generate_mosaic_of_3d_cubes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>list1_3d_images_ADRTHEOR.txt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>combination_test1_3d_ADRTHEOR.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose
</pre></div>
</div>
<div class="my-special-block no-copybutton highlight-default notranslate"><div class="highlight"><pre><span></span>input_list: list1_3d_images_ADRTHEOR.txt
output_filename: combination_test1_3d_ADRTHEOR.fits
crval3out: None
cdelt3out: None
naxis3out: None
desired_celestial_2d_wcs: None
reproject_method: adaptive
parallel: False
extname_image: PRIMARY
output_celestial_2d_wcs: None
footprint: True
verbose: True
echo: False
Total number of images to be combined: 3
hdu.header[&quot;NAXIS1&quot;]=64, hdu.header[&quot;NAXIS2&quot;]=60, hdu.header[&quot;NAXIS3&quot;]=2048
hdu.header[&quot;NAXIS1&quot;]=86, hdu.header[&quot;NAXIS2&quot;]=84, hdu.header[&quot;NAXIS3&quot;]=2048
hdu.header[&quot;NAXIS1&quot;]=86, hdu.header[&quot;NAXIS2&quot;]=84, hdu.header[&quot;NAXIS3&quot;]=2048

crval3out=&lt;SpectralCoord 1.9344e-06 m&gt;
cdelt3out=&lt;Quantity 2.85e-10 m / pix&gt;
naxis3out=2048
wavemax  =&lt;Quantity 2.517795e-06 m&gt;

wcs1d_spectral_mosaic=WCS Keywords

Number of WCS axes: 1
CTYPE : &#39;WAVE&#39; 
CRVAL : 1.9344e-06 
CRPIX : 1.0 
PC1_1  : 1.0 
CDELT : 2.84999999999608e-10 
NAXIS : 2048  0

Celestial scales:
Image 1: 0.010 arcsec, 0.010 arcsec
Image 2: 0.010 arcsec, 0.010 arcsec
Image 3: 0.010 arcsec, 0.010 arcsec
Mosaic : 0.010 arcsec, 0.010 arcsec

wcs_mosaic2d=WCS Keywords

Number of WCS axes: 2
CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39; 
CRVAL : 7.160825485831836e-31 0.0 
CRPIX : 44.22578218656925 43.03043723364317 
PC1_1 PC1_2  : 1.0 0.0 
PC2_1 PC2_2  : 0.0 1.0 
CDELT : -2.7777777777777e-06 2.7777777777777e-06 
NAXIS : 0  0

shape_mosaic2d=(84, 87)

NAXIS1, NAXIS2, NAXIS3 of 3D mosaic: 87, 84, 2048
Combined image will require 71.37 Mbyte

* Working with: test1a_ifu_3D_method0.fits
Old and new wavelength borders are the same.
-&gt; Copying original data without spectral resampling.
Celestial WCS reprojection method: adaptive
Processing time for test1a_ifu_3D_method0.fits: 0:00:00.736472

* Working with: test1b_ifu_3D_method0_corrected_ADRTHEOR.fits
Old and new wavelength borders are the same.
-&gt; Copying original data without spectral resampling.
Celestial WCS reprojection method: adaptive
Processing time for test1b_ifu_3D_method0_corrected_ADRTHEOR.fits: 0:00:01.206074

* Working with: test1c_ifu_3D_method0_corrected_ADRTHEOR.fits
Old and new wavelength borders are the same.
-&gt; Copying original data without spectral resampling.
Celestial WCS reprojection method: adaptive
Processing time for test1c_ifu_3D_method0_corrected_ADRTHEOR.fits: 0:00:01.385879
Saving: combination_test1_3d_ADRTHEOR.fits

Total time: 0:00:03.422615
Done!
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ds9<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-scale<span class="w"> </span>mode<span class="w"> </span>minmax<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-geometry<span class="w"> </span>1000x1000<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-wcs<span class="w"> </span>degrees<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-multiframe<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1a_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1b_ifu_3D_method0_corrected_ADRTHEOR.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test1c_ifu_3D_method0_corrected_ADRTHEOR.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>combination_test1_3d_ADRTHEOR.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-lock<span class="w"> </span>slice<span class="w"> </span>image<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-lock<span class="w"> </span>frame<span class="w"> </span>image<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-zoom<span class="w"> </span>to<span class="w"> </span>fit<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-cmap<span class="w"> </span>viridis<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-match<span class="w"> </span>frame<span class="w"> </span>colorbar<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-match<span class="w"> </span>frame<span class="w"> </span>wcs<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-colorbar<span class="w"> </span>lock<span class="w"> </span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-view<span class="w"> </span>multi<span class="w"> </span>yes
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/result_example1_ADRTHEOR_with_ds9.png"><img alt="../_images/result_example1_ADRTHEOR_with_ds9.png" class="align-center" src="../_images/result_example1_ADRTHEOR_with_ds9.png" style="width: 100%;" />
</a>
<p>In the upper image, from top to bottom and left to right, we have the cubes
corresponding to: the first exposure, the second exposure corrected using
<code class="docutils literal notranslate"><span class="pre">ADRTHEOR</span></code>, the mask of the previous cube, the third exposure corrected using
<code class="docutils literal notranslate"><span class="pre">ADRTHEOR</span></code>, the mask of the previous cube, the combination of the 3 cubes, and
the footprint of that combination. It is very interesting to move along the
wavelength using the slider that <code class="docutils literal notranslate"><span class="pre">ds9</span></code> provides in an auxiliary window.</p>
<p>Finally, we can compare the effect of correcting or not correcting for
atmospheric refraction.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ds9<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-scale<span class="w"> </span>mode<span class="w"> </span>minmax<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-geometry<span class="w"> </span>1000x1000<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-wcs<span class="w"> </span>degrees<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-multiframe<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>combination_test1_3d.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>combination_test1_3d_ADRTHEOR.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-lock<span class="w"> </span>slice<span class="w"> </span>image<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-lock<span class="w"> </span>frame<span class="w"> </span>image<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-zoom<span class="w"> </span>to<span class="w"> </span>fit<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-cmap<span class="w"> </span>viridis<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-match<span class="w"> </span>frame<span class="w"> </span>colorbar<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-match<span class="w"> </span>frame<span class="w"> </span>wcs<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-colorbar<span class="w"> </span>lock<span class="w"> </span>yes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-view<span class="w"> </span>multi<span class="w"> </span>yes
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/result_example1_without_with_ADR_ds9.png"><img alt="../_images/result_example1_without_with_ADR_ds9.png" class="align-center" src="../_images/result_example1_without_with_ADR_ds9.png" style="width: 100%;" />
</a>
<p>The top row shows the combined cube and the associated footprint when the
combination is carried out without taking into account the effect of
differential atmospheric refraction, while the bottom row shows the result when
this effect is taken into account. Once again, it is important to interact with
the display by moving along the wavelength axis. This clearly reveals the need
to apply the correction.</p>
<p><strong>ToDo</strong>: add the option to correct for atmospheric refraction by generating a
corrected cube with a predefined celestial WCS with an arbitrary size.  In this
way, instead of interpolating when correcting for atmospheric refraction and
when combining cubes with different pointings, we would only perform a single
interpolation at the time of atmospheric refraction correction.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Auxiliary tools" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024-2026, Nicolás Cardiel, Sergio Pascual.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>