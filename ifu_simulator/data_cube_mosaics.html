

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generation of data cube mosaics &mdash; fridadrp-tutorials 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Running a simple test recipe" href="../example_recipes/test1.html" />
    <link rel="prev" title="Some scene examples" href="examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            fridadrp-tutorials
              <img src="../_static/logo_FRIDA.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/installation.html">Installing the development version</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Running the IFU simulator</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="initial_example.html">Initial example</a></li>
<li class="toctree-l2"><a class="reference internal" href="script_arguments.html">Script arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="scene_yaml.html">The scene YAML file</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">Some scene examples</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Generation of data cube mosaics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#combination-of-2d-images">Combination of 2D images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generation-of-example-3d-data-cubes">Generation of example 3D data cubes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../example_recipes/test1.html">Running a simple test recipe</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">fridadrp-tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Running the IFU simulator</a></li>
      <li class="breadcrumb-item active">Generation of data cube mosaics</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/ifu_simulator/data_cube_mosaics.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="generation-of-data-cube-mosaics">
<h1>Generation of data cube mosaics<a class="headerlink" href="#generation-of-data-cube-mosaics" title="Link to this heading"></a></h1>
<p>Here is the procedure that can be used to generate mosaics with data cubes.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Please note that the code shown below is under development and may undergo
modifications.</p>
</div>
<p>Before tackling the combination of 3D data cubes, let’s see how the <code class="docutils literal notranslate"><span class="pre">numina</span></code>
package facilitates the combination of 2D images.</p>
<section id="combination-of-2d-images">
<h2>Combination of 2D images<a class="headerlink" href="#combination-of-2d-images" title="Link to this heading"></a></h2>
<p>For this example we are using the files <a class="reference download internal" download="" href="../_downloads/659659033d72306aecb52b3a72d10999/scene_m51_2d.yaml"><code class="xref download docutils literal notranslate"><span class="pre">scene_m51_2d.yaml</span></code></a> and <a class="reference download internal" download="" href="../_downloads/83a371fc5279f0047c944cd838479a42/m51_dss1.fits"><code class="xref download docutils literal notranslate"><span class="pre">m51_dss1.fits</span></code></a>.</p>
<p>Execute <code class="docutils literal notranslate"><span class="pre">fridadrp-ifu_simulator</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_2d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>coarse<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_ra_teles_arcsec<span class="w"> </span><span class="m">0</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_dec_teles_arcsec<span class="w"> </span><span class="m">0</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">0</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--flatpix2pix<span class="w"> </span>none<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>testa
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_2d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>fine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_ra_teles_arcsec<span class="w"> </span>-0.1<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_dec_teles_arcsec<span class="w"> </span>-0.2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">40</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--flatpix2pix<span class="w"> </span>none<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>testb
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_2d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>fine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_ra_teles_arcsec<span class="w"> </span><span class="m">0</span>.2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--delta_dec_teles_arcsec<span class="w"> </span><span class="m">0</span>.2<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">20</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--flatpix2pix<span class="w"> </span>none<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>testc
</pre></div>
</div>
<p>We have used the parameter <code class="docutils literal notranslate"><span class="pre">--stop_after_ifu_3D_method0</span></code> because we do not
need to execute all the steps of the simulator to generate the images we will
need in this case. Note that the first execution uses <code class="docutils literal notranslate"><span class="pre">--scale</span> <span class="pre">coarse</span></code>, while the
next two use <code class="docutils literal notranslate"><span class="pre">--scale</span> <span class="pre">fine</span></code>. Additionally, the values of
<code class="docutils literal notranslate"><span class="pre">--delta_ra_teles_arcsec</span></code>, <code class="docutils literal notranslate"><span class="pre">--delta_dec_teles_arcsec</span></code>, and
<code class="docutils literal notranslate"><span class="pre">--instrument_pa_deg</span> <span class="pre">are</span> <span class="pre">modified</span></code>.</p>
<a class="reference internal image-reference" href="../_images/individual_m51_exposures.png"><img alt="../_images/individual_m51_exposures.png" src="../_images/individual_m51_exposures.png" style="width: 100%;" />
</a>
<p>The next step is to generate an auxiliary text file with the names of the FITS
images to be combined.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ls<span class="w"> </span>test?_ifu_white2D_method0_os1.fits<span class="w"> </span>&gt;<span class="w"> </span>list_2d_images.txt
<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>cat<span class="w"> </span>list_2d_images.txt
<span class="go">testa_ifu_white2D_method0_os1.fits</span>
<span class="go">testb_ifu_white2D_method0_os1.fits</span>
<span class="go">testc_ifu_white2D_method0_os1.fits</span>
</pre></div>
</div>
<p>To combine the 3 selected images, we only need to execute the following Numina
script:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-generate_mosaic_of_2d_images<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>list_2d_images.txt<span class="w"> </span>combination_2d.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose
<span class="go">input_list: list_2d_images.txt</span>
<span class="go">output_filename: combination_2d.fits</span>
<span class="go">reproject_method: adaptive</span>
<span class="go">extname_image: PRIMARY</span>
<span class="go">extname_mask: None</span>
<span class="go">combination_function: mean</span>
<span class="go">output_3D_stack: None</span>
<span class="go">verbose: True</span>
<span class="go">echo: False</span>

<span class="go">* Reading: testa_ifu_white2D_method0_os1.fits</span>
<span class="go">hdu2d_image.header[&#39;NAXIS1&#39;]=64</span>
<span class="go">hdu2d_image.header[&#39;NAXIS2&#39;]=60</span>
<span class="go">generating mask from np.nan values</span>
<span class="go">Number of masked pixels / total: 0 / 3840</span>

<span class="go">* Reading: testb_ifu_white2D_method0_os1.fits</span>
<span class="go">hdu2d_image.header[&#39;NAXIS1&#39;]=64</span>
<span class="go">hdu2d_image.header[&#39;NAXIS2&#39;]=60</span>
<span class="go">generating mask from np.nan values</span>
<span class="go">Number of masked pixels / total: 0 / 3840</span>

<span class="go">* Reading: testc_ifu_white2D_method0_os1.fits</span>
<span class="go">hdu2d_image.header[&#39;NAXIS1&#39;]=64</span>
<span class="go">hdu2d_image.header[&#39;NAXIS2&#39;]=60</span>
<span class="go">generating mask from np.nan values</span>
<span class="go">Number of masked pixels / total: 0 / 3840</span>
<span class="go">Total number of images to be combined: 3</span>

<span class="go">wcs_mosaic2d=WCS Keywords</span>

<span class="go">Number of WCS axes: 2</span>
<span class="go">CTYPE : &#39;RA---TAN&#39; &#39;DEC--TAN&#39;</span>
<span class="go">CRVAL : 9.259258514947486e-06 0.0</span>
<span class="go">CRPIX : 125.16666693574936 120.50000000417663</span>
<span class="go">PC1_1 PC1_2  : 1.0 0.0</span>
<span class="go">PC2_1 PC2_2  : 0.0 1.0</span>
<span class="go">CDELT : -2.7777777777777233e-06 2.7777777777777233e-06</span>
<span class="go">NAXIS : 0  0</span>
<span class="go">shape_mosaic2d=(240, 256)</span>
<span class="go">Reprojection method: adaptive</span>
<span class="go">Combination function: mean</span>

<span class="go">Saving combined 2D image: combination_2d.fits</span>
</pre></div>
</div>
<p>Next, we compare the result of the combination of the 3 simulated exposures
with the first exposure alone: both
cover the field of the <em>coarse</em> camera. The improvement in spatial resolution
in the combined image is noticeable after including the two pointings made with
the <em>fine</em> camera.  Note that the combined image has the sampling corresponding
to the <em>fine</em> camera. Hence, the number of counts shows such a different value
in both images.</p>
<a class="reference internal image-reference" href="../_images/comparison_combined_single.png"><img alt="../_images/comparison_combined_single.png" src="../_images/comparison_combined_single.png" style="width: 100%;" />
</a>
<p>The following figure shows the result of combining the two exposures obtained
with the ‘fine’ camera, represented on top of the first exposure calculated
with an oversampling of 10 (file <code class="docutils literal notranslate"><span class="pre">testa_ifu_white2D_method0_os10.fits</span></code>).</p>
<a class="reference internal image-reference" href="../_images/combined_with_bw_background.png"><img alt="../_images/combined_with_bw_background.png" class="align-center" src="../_images/combined_with_bw_background.png" style="width: 70%;" />
</a>
</section>
<section id="generation-of-example-3d-data-cubes">
<h2>Generation of example 3D data cubes<a class="headerlink" href="#generation-of-example-3d-data-cubes" title="Link to this heading"></a></h2>
<p>For this example we are using the files <a class="reference download internal" download="" href="../_downloads/e5cb314fc790d129a917d6c6e6dc26fb/scene_m51_3d.yaml"><code class="xref download docutils literal notranslate"><span class="pre">scene_m51_3d.yaml</span></code></a> and <a class="reference download internal" download="" href="../_downloads/83a371fc5279f0047c944cd838479a42/m51_dss1.fits"><code class="xref download docutils literal notranslate"><span class="pre">m51_dss1.fits</span></code></a>.</p>
<p>Execute <code class="docutils literal notranslate"><span class="pre">fridadrp-ifu_simulator</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_3d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>fine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--airmass<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--parallactic_angle_deg<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>test_m51a<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">1234</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_3d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>fine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--airmass<span class="w"> </span><span class="m">3</span>.00<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--parallactic_angle_deg<span class="w"> </span><span class="m">45</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>test_m51b<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">2345</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fridadrp-ifu_simulator<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scene<span class="w"> </span>scene_m51_3d.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--grating<span class="w"> </span>medium-K<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--scale<span class="w"> </span>fine<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--airmass<span class="w"> </span><span class="m">3</span>.00<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--parallactic_angle_deg<span class="w"> </span>-45<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--instrument_pa_deg<span class="w"> </span><span class="m">340</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--stop_after_ifu_3D_method0<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--prefix_intermediate_FITS<span class="w"> </span>test_m51c<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--seed<span class="w"> </span><span class="m">3456</span>
</pre></div>
</div>
<p>We have used again the parameter <code class="docutils literal notranslate"><span class="pre">--stop_after_ifu_3D_method0</span></code> because we do
not need to execute all the steps of the simulator to generate the images we
will need in this example. In all cases, we are using the <em>fine</em> camera.  In
the first exposure, the airmass is 1.0. In the next two exposures we have
chosen a high airmass to exaggerate the effect of atmospheric refraction,
modifying both the value of the parallactic angle and the instrument.</p>
<p>We can quickly visualize the result with the help of the <code class="docutils literal notranslate"><span class="pre">qfitsview</span></code> program.
With the idea of being able to change the slice in the spectral direction
simultaneously in the three exposures, we will first generate an auxiliary
image that performs a stack of the HDUs (header and data units) from different
FITS files into a single FITS file.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fitsinfo<span class="w"> </span>test_m51*3D*.fits
<span class="go">Filename: test_m51a_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      81   (64, 60, 2048)   float32</span>

<span class="go">Filename: test_m51b_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      83   (64, 60, 2048)   float32</span>

<span class="go">Filename: test_m51c_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      83   (64, 60, 2048)   float32</span>

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ls<span class="w"> </span>test_m51*3D*.fits<span class="w"> </span>&gt;<span class="w"> </span>list_3d_images.txt

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>cat<span class="w"> </span>list_3d_images.txt
<span class="go">test_m51a_ifu_3D_method0.fits</span>
<span class="go">test_m51b_ifu_3D_method0.fits</span>
<span class="go">test_m51c_ifu_3D_method0.fits</span>

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-stack_hdus<span class="w"> </span>list_3d_images.txt<span class="w"> </span>stack_3d.fits

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>qfitsview<span class="w"> </span>stack_3d.fits
</pre></div>
</div>
<p>After executing the last command, select ‘Read All’ when <code class="docutils literal notranslate"><span class="pre">qfitsview</span></code> asks for
the extension to read.</p>
<p>If we collapse the data cubes along the spectral direction (NAXIS3), the effect
of atmospheric refraction is clearly noticeable.</p>
<a class="reference internal image-reference" href="../_images/individual_3d_m51_exposures.png"><img alt="../_images/individual_3d_m51_exposures.png" src="../_images/individual_3d_m51_exposures.png" style="width: 100%;" />
</a>
<p>If we combine the 3 data cubes ignoring the problem of atmospheric refraction,
the result is not satisfactory.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-generate_mosaic_of_3d_cubes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>list_3d_images.txt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>combination_3d.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose

<span class="gp">$ </span>fitsinfo<span class="w"> </span>combination_3d.fits
<span class="go">Filename: combination_3d.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      27   (81, 78, 2048)   float32</span>
<span class="go">  1  FOOTPRINT     1 ImageHDU        29   (81, 78, 2048)   uint8</span>

<span class="gp">$ </span>qfitsview<span class="w"> </span>combination_3d.fits
</pre></div>
</div>
<p>It is advisable to correct the individual exposures first before combining the
different data cubes.</p>
<p>We can use an initial script that allows us to understand the expected effect
of atmospheric refraction.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-compute_adr_wavelength<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--airmass<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--reference_wave_vacuum<span class="w"> </span><span class="m">1</span>.7<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--wave_ini<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--wave_end<span class="w"> </span><span class="m">2</span>.5<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--wave_step<span class="w"> </span><span class="m">0</span>.1<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--wave_unit<span class="w"> </span>micron<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--plots

<span class="go">Wavelength  ADR</span>
<span class="go">  micron   arcsec</span>
<span class="go">---------- ------</span>
<span class="go">     1.000  0.483</span>
<span class="go">     1.100  0.355</span>
<span class="go">     1.200  0.257</span>
<span class="go">     1.300  0.181</span>
<span class="go">     1.400  0.121</span>
<span class="go">     1.500  0.072</span>
<span class="go">     1.600  0.033</span>
<span class="go">     1.700  0.000</span>
<span class="go">     1.800 -0.027</span>
<span class="go">     1.900 -0.051</span>
<span class="go">     2.000 -0.071</span>
<span class="go">     2.100 -0.088</span>
<span class="go">     2.200 -0.102</span>
<span class="go">     2.300 -0.115</span>
<span class="go">     2.400 -0.127</span>
<span class="go">     2.500 -0.137</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/adr_prediction.png"><img alt="../_images/adr_prediction.png" class="align-center" src="../_images/adr_prediction.png" style="width: 60%;" />
</a>
<p>When correcting each individual exposure, we will first insert an extension
with a binary table that stores the effect of atmospheric refraction into each
FITS file.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-include_adrtheor_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test_m51b_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose<span class="w"> </span>--plots

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-include_adrtheor_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test_m51c_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose<span class="w"> </span>--plots
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/adr_m51b.png"><img alt="../_images/adr_m51b.png" class="align-center" src="../_images/adr_m51b.png" style="width: 60%;" />
</a>
<a class="reference internal image-reference" href="../_images/adr_m51c.png"><img alt="../_images/adr_m51c.png" class="align-center" src="../_images/adr_m51c.png" style="width: 60%;" />
</a>
<p><strong>Important</strong>: the previous step stores the correction to be applied but does
not apply it to the data. To perform this process, we need to use an additional
script.</p>
<p>We see that a new extension <code class="docutils literal notranslate"><span class="pre">ADRTHEOR</span></code> has appeared in each data cube.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fitsinfo<span class="w"> </span>test_m51*3D*.fits
<span class="go">Filename: test_m51a_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      81   (64, 60, 2048)   float32</span>
<span class="go">  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]</span>

<span class="go">Filename: test_m51b_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      83   (64, 60, 2048)   float32</span>
<span class="go">  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]</span>

<span class="go">Filename: test_m51c_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      83   (64, 60, 2048)   float32</span>
<span class="go">  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]</span>
</pre></div>
</div>
<p>We can also empirically measure atmospheric refraction in each data cube using
cross-correlation.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-measure_slice_xy_offsets_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test_m51b_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--iterate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname<span class="w"> </span>adrcross<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose<span class="w"> </span>--iterate<span class="w"> </span>--plots

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-measure_slice_xy_offsets_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test_m51c_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--iterate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname<span class="w"> </span>adrcross<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose<span class="w"> </span>--iterate<span class="w"> </span>--plots
</pre></div>
</div>
<p>The previous procedure has added a new extension <code class="docutils literal notranslate"><span class="pre">ADRCROSS</span></code> to each of the
corrected images.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>fitsinfo<span class="w"> </span>test_m51*3D*.fits
<span class="go">Filename: test_m51a_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      81   (64, 60, 2048)   float32</span>
<span class="go">  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]</span>

<span class="go">Filename: test_m51b_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      83   (64, 60, 2048)   float32</span>
<span class="go">  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]</span>
<span class="go">  2  ADRCROSS      1 BinTableHDU     24   2048R x 2C   [D, D]</span>

<span class="go">Filename: test_m51c_ifu_3D_method0.fits</span>
<span class="go">No.    Name      Ver    Type      Cards   Dimensions   Format</span>
<span class="go">  0  PRIMARY       1 PrimaryHDU      83   (64, 60, 2048)   float32</span>
<span class="go">  1  ADRTHEOR      1 BinTableHDU     21   2048R x 2C   [D, D]</span>
<span class="go">  2  ADRCROSS      1 BinTableHDU     24   2048R x 2C   [D, D]</span>
</pre></div>
</div>
<p>We can easily compare the expected atmospheric refraction with that calculated
using the cross-correlation technique.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-compare_adr_extensions_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test_m51b_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>adrcross<span class="w"> </span>adrtheor
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/adrcross_adrtheor.png"><img alt="../_images/adrcross_adrtheor.png" class="align-center" src="../_images/adrcross_adrtheor.png" style="width: 80%;" />
</a>
<p>At this point, we can correct the exposures for atmospheric refraction using
the preferred extension (in this case, <code class="docutils literal notranslate"><span class="pre">ADRCROSS</span></code> or <code class="docutils literal notranslate"><span class="pre">ADRTHEOR</span></code>).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-adr_correction_from_extension_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test_m51b_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname_adr<span class="w"> </span>adrtheor<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname_mask<span class="w"> </span>None<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>test_m51b_ifu_3D_method0_corrected_ADRTHEOR.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-adr_correction_from_extension_in_3d_cube<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test_m51c_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname_adr<span class="w"> </span>adrtheor<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--extname_mask<span class="w"> </span>None<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>test_m51c_ifu_3D_method0_corrected_ADRTHEOR.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ls<span class="w"> </span>test_m51a_ifu_3D_method0.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>test_m51*_ADRTHEOR.fits<span class="w"> </span>&gt;<span class="w"> </span>list_3d_images_ADRTHEOR.txt

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="go">cat list_3d_images_ADRTHEOR.txt</span>
<span class="go">test_m51a_ifu_3D_method0.fits</span>
<span class="go">test_m51b_ifu_3D_method0_corrected_ADRTHEOR.fits</span>
<span class="go">test_m51c_ifu_3D_method0_corrected_ADRTHEOR.fits</span>
</pre></div>
</div>
<p>Now we can add the 3 data cubes.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-generate_mosaic_of_3d_cubes<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>list_3d_images_ADRTHEOR.txt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>combination_3d_ADRTHEOR.fits<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--verbose

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>qfitsview<span class="w"> </span>combination_3d_ADRTHEOR.fits
</pre></div>
</div>
<p>Finally, we can compare the effect of correcting or not correcting for
atmospheric refraction.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>ls<span class="w"> </span>combination_3d*.fits<span class="w"> </span>&gt;<span class="w"> </span>list_3d_combinations.txt

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>numina-stack_hdus<span class="w"> </span>list_3d_combinations.txt<span class="w"> </span>stack_3d_combinations.fits

<span class="gp gp-VirtualEnv">(venv_frida)</span> <span class="gp">$ </span>qfitsview<span class="w"> </span>stack_3d_combinations.fits
</pre></div>
</div>
<p>ToDo: add the option to correct for atmospheric refraction by generating a
corrected cube with a predefined celestial WCS with an arbitrary size.  In this
way, instead of interpolating when correcting for atmospheric refraction and
when combining cubes with different pointings, we would only perform a single
interpolation at the time of atmospheric refraction correction.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="examples.html" class="btn btn-neutral float-left" title="Some scene examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../example_recipes/test1.html" class="btn btn-neutral float-right" title="Running a simple test recipe" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Nicolás Cardiel, Sergio Pascual.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>